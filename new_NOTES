from PIL import Image, ImageEnhance, ImageFilter, ImageDraw
import numpy as np
import matplotlib.pyplot as plt

def move_text_preserve_background(image_path, coordinates, direction, percent):
    # Load the original image
    img = Image.open(image_path)

    # Step 1: Convert to grayscale and enhance contrast
    gray = img.convert("L")
    inc = ImageEnhance.Contrast(gray)
    enhanced_gray = inc.enhance(2.0)
    sharpened_gray = enhanced_gray.filter(ImageFilter.SHARPEN)

    # Extract coordinates
    xmin, ymin, xmax, ymax = coordinates

    # Step 2: Crop the text region from the enhanced grayscale image
    cropped_gray = sharpened_gray.crop((xmin, ymin, xmax, ymax))

    # Step 3: Move the text based on direction and percentage
    dx = int(img.width * percent / 100)
    dy = int(img.height * percent / 100)

    if direction == 'up':
        new_y = max(0, ymin - dy)
        moved_position = (xmin, new_y)
    elif direction == 'down':
        new_y = min(img.height - (ymax - ymin), ymin + dy)
        moved_position = (xmin, new_y)
    elif direction == 'left':
        new_x = max(0, xmin - dx)
        moved_position = (new_x, ymin)
    elif direction == 'right':
        new_x = min(img.width - (xmax - xmin), xmin + dx)
        moved_position = (new_x, ymin)

    # Step 4: Overlay the grayscale moved text on the original image
    img_copy = img.copy()
    img_copy.paste(cropped_gray, moved_position)

    # Step 5: Restore color using the original image
    colored_cropped = img.crop((xmin, ymin, xmax, ymax))
    img_copy.paste(colored_cropped, moved_position, cropped_gray)

    # Display the final image
    plt.figure(figsize=(10, 8))
    plt.imshow(img_copy)
    plt.title(f"Text moved {direction} by {percent}% while retaining background")
    plt.axis('off')
    plt.show()

# Example usage
image_path = "/mnt/data/Screenshot 2025-05-13 at 8.01.28â€¯PM.png"
coordinates = (50, 50, 200, 100)  # Example coordinates
move_text_preserve_background(image_path, coordinates, 'right', 5)
